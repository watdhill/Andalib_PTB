// Ganti 'postgresql' dengan 'mysql' atau 'sqlite' jika berbeda
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ----------------------------------------------------
// ENUM DEFINITIONS
// ----------------------------------------------------

enum Gender {
  LAKI_LAKI
  PEREMPUAN
}

enum Faculty {
  HUKUM
  PERTANIAN
  KEDOKTERAN
  MIPA
  EKONOMI_BISNIS
  PETERNAKAN
  ILMU_BUDAYA
  FISIP
  TEKNIK
  FARMASI
  TEKNOLOGI_PERTANIAN
  KESEHATAN_MASYARAKAT
  KEPERAWATAN
  KEDOKTERAN_GIGI
  TEKNOLOGI_INFORMASI
}

enum Major {
  ILMU_HUKUM
  AGRIBISNIS
  AGROTEKNOLOGI
  ILMU_TANAH
  PROTEKSI_TANAMAN
  PENYULUHAN_PERTANIAN
  AGROEKOTEKNOLOGI
  
  PENDIDIKAN_DOKTER
  KEBIDANAN
  PSIKOLOGI
  ILMU_BIOMEDIS

  KIMIA
  BIOLOGI
  MATEMATIKA
  FISIKA

  EKONOMI
  MANAJEMEN
  AKUNTANSI

  PRODUKSI_TERNAK
  NUTRISI_DAN_MAKANAN_TERNAK

  ILMU_SEJARAH
  SASTRA_INGGRIS
  SASTRA_INDONESIA
  SASTRA_MINANGKABAU
  SASTRA_JEPANG

  ILMU_POLITIK
  SOSIOLOGI
  ANTROPOLOGI_SOSIAL
  ILMU_HUBUNGAN_INTERNASIONAL
  ILMU_KOMUNIKASI
  ADMINISTRASI_PUBLIK

  TEKNIK_MESIN
  TEKNIK_SIPIL
  TEKNIK_LINGKUNGAN
  TEKNIK_INDUSTRI
  TEKNIK_ELEKTRO
  
  FARMASI

  TEKNOLOGI_PANGAN_HASIL_PERTANIAN
  TEKNIK_PERTANIAN_BIOSISTEM
  TEKNOLOGI_INDUSTRI_PERTANIAN

  KESEHATAN_MASYARAKAT
  GIZI

  KEPERAWATAN

  PENDIDIKAN_DOKTER_GIGI

  SISTEM_INFORMASI
  INFORMATIKA
  TEKNIK_KOMPUTER
}

// Enum untuk Status Peminjaman
enum StatusPeminjaman {
  DIPINJAM
  DIKEMBALIKAN
}

// ----------------------------------------------------
// ADMIN
// ----------------------------------------------------

model Admin {
  id         Int        @id @default(autoincrement())
  email      String     @unique
  password   String
  name       String

  // Relasi: Admin yang mencatat peminjaman
  Peminjaman Peminjaman[]
  
  // Relasi: Notifikasi yang diterima admin
  notifications Notification[]
}

// ----------------------------------------------------
// ANGGOTA â€” PRIMARY KEY = NIM
// ----------------------------------------------------

model Anggota {
  nim              String   @id
  name             String
  gender           Gender
  faculty          Faculty
  major            Major
  contact          String
  email            String?
  photoPath        String?
  registrationDate DateTime @default(now())

  // Relasi: Satu anggota bisa punya banyak peminjaman
  Peminjaman Peminjaman[]
}

// ----------------------------------------------------
// KATEGORI & BUKU
// ----------------------------------------------------

model Kategori {
  id   Int    @id @default(autoincrement())
  name String @unique

  Buku Buku[]
}

model Buku {
  id              Int        @id @default(autoincrement())
  title           String
  author          String
  publicationYear Int?
  stok            Int        @default(1) // Jumlah stok buku

  kategoriId Int
  kategori   Kategori @relation(fields: [kategoriId], references: [id])

  Peminjaman Peminjaman[]
}

// ----------------------------------------------------
// TRANSAKSI (PEMINJAMAN & PENGEMBALIAN)
// ----------------------------------------------------

// Tabel Peminjaman: Mencatat data AWAL saat buku keluar
model Peminjaman {
  id            Int              @id @default(autoincrement())
  tanggalPinjam DateTime         @default(now())
  jatuhTempo    DateTime
  status        StatusPeminjaman @default(DIPINJAM) // Status aktif/selesai

  // Path foto KRS (opsional)
  krsImagePath  String?

  // Relasi Buku
  bukuId Int
  buku   Buku @relation(fields: [bukuId], references: [id])

  // Relasi Anggota
  anggotaNim String
  anggota    Anggota @relation(fields: [anggotaNim], references: [nim])

  // Relasi Admin (Pencatat)
  adminId Int?
  admin   Admin? @relation(fields: [adminId], references: [id])

  // Relasi ke Pengembalian (One-to-One, Opsional)
  pengembalian Pengembalian?
}

// Tabel Pengembalian: Mencatat data AKHIR saat buku kembali
model Pengembalian {
  id                  Int      @id @default(autoincrement())
  tanggalPengembalian DateTime @default(now())
  denda               Int      @default(0) // Jumlah denda

  // Bukti kerusakan buku (URL atau path file, bersifat opsional)
  buktiKerusakanUrl   String?  
  
  // Opsional: Catatan tambahan mengenai kondisi buku, dll
  keterangan          String? 

  // Relasi Balik ke Peminjaman (Foreign Key)
  peminjamanId Int      @unique
  peminjaman   Peminjaman @relation(fields: [peminjamanId], references: [id])
}

// ============================================================
// NOTIFICATION SYSTEM - GENERIC UNTUK SEMUA JENIS NOTIFIKASI
// ============================================================
// Model generic untuk semua notifikasi (member, buku, peminjaman, dll)
// Lebih scalable dan future-proof

model Notification {
  id        Int      @id @default(autoincrement())
  
  // Admin yang menerima notifikasi
  adminId   Int
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  // Tipe notifikasi (untuk filtering dan badge)
  type      String   // "MEMBER_DELETED", "BOOK_ADDED", "RETURN_OVERDUE", etc
  
  // Konten notifikasi
  title     String   // "Anggota Dihapus", "Buku Baru", etc
  message   String   @db.Text // Pesan lengkap
  
  // Metadata fleksibel untuk data tambahan (JSON format)
  // Contoh: {"memberName": "John", "memberNim": "123", "deletedBy": "Admin A"}
  metadata  String?  @db.Text
  
  // Status baca
  isRead    Boolean  @default(false)
  readAt    DateTime? // Timestamp kapan dibaca (untuk auto-delete 2 menit kemudian)
  
  // Timestamp
  createdAt DateTime @default(now())
  
  // Indexes untuk query cepat
  @@index([adminId, isRead ])
  @@index([type])
  @@index([createdAt])
}

